# -*- coding: utf-8 -*-
import asyncio
import logging
import os

import discord
import lavaplay
import lavaplay.player
from discord import Interaction, app_commands
from discord.ext import commands

from config import MUSIC_DEFAULT_VOLUME

# Load environment variables
LAVALINK_HOST = os.getenv("LAVALINK_HOST", "localhost")
LAVALINK_PORT = int(os.getenv("LAVALINK_PORT", 2333))
LAVALINK_PASSWORD = os.getenv("LAVALINK_PASSWORD", "youshallnotpass")

logger = logging.getLogger("MusicCog")


class MusicCog(commands.Cog):
    def __init__(self, bot: commands.Bot):
        self.bot = bot
        self._current_volume = MUSIC_DEFAULT_VOLUME
        self.lavalink = lavaplay.Lavalink()
        self.node = None

    async def cog_unload(self) -> None:
        await self.node.close()
        for i in self.lavalink.nodes:
            await i.close()
        self.lavalink.nodes = list()

    async def cog_load(self):
        if self.bot.is_ready():
            await self.initialize_node()

    @commands.Cog.listener()
    async def on_ready(self):
        await self.initialize_node()

    async def initialize_node(self):
        """Safely initialize Lavalink node"""
        if self.node and self.node.is_connect:
            return
        await self._connect_node()

    async def _get_player(self, guild_id: int) -> lavaplay.player.Player:
        """Get existing player or create new one with proper voice data"""
        await self.initialize_node()  # Ensure node is connected
        player = self.node.get_player(guild_id)
        if not player:
            player = self.node.create_player(guild_id)
        return player

    async def _connect_node(self):
        """Full node connection sequence"""
        try:
            if self.lavalink.nodes:
                self.node = self.lavalink.default_node
            else:
                self.node = self.lavalink.create_node(
                    host=LAVALINK_HOST,
                    port=LAVALINK_PORT,
                    password=LAVALINK_PASSWORD,
                    user_id=self.bot.user.id,
                )
            self.node.set_event_loop(self.bot.loop)
            self.node.connect()
            await asyncio.wait_for(self._wait_for_connection(), timeout=10)
            logger.info("Node connected successfully")
        except Exception as e:
            logger.error("Node connection failed: %s", e)
            raise

    async def _check_and_reconnect_node(self) -> bool:
        """Verify Lavalink node connection"""
        if not self.node.is_connect:
            logger.warning("Lavalink node not connected")
            try:
                await self._connect_node()
                return True
            except Exception as e:
                logger.error("Node reconnect failed: %s", e)
                return False
        return True

    async def _wait_for_connection(self):
        """Wait until node is fully connected"""
        while not self.node.is_connect:
            await asyncio.sleep(0.1)

    @app_commands.command(name="join", description="–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –≥–æ–ª–æ—Å–æ–≤–æ–º—É –∫–∞–Ω–∞–ª—É")
    async def join(
        self, interaction: Interaction, *, channel: discord.VoiceChannel = None
    ):
        """Join your current voice channel"""
        await interaction.response.defer(ephemeral=True)
        try:
            if not await self._ensure_voice(interaction, None):
                return

            success_message = (
                f"‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ {interaction.user.voice.channel.mention}"
            )
            logger.info(success_message)
            await interaction.followup.send(
                success_message, ephemeral=True, silent=True
            )

        except discord.ClientException as e:
            error_message = "‚ùå –£–∂–µ –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ –≥–æ–ª–æ—Å–æ–≤–æ–º—É –∫–∞–Ω–∞–ª—É!"
            await interaction.followup.send(error_message, ephemeral=True)
            logger.error("Discord ClientException error in join: %s", e)
        except Exception as e:
            error_message = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏."
            await interaction.followup.send(error_message, ephemeral=True)
            logger.exception("Unexpected error in join command: %s", e)

    @app_commands.command(
        name="play",
        description="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º—É–∑—ã–∫–∏ —Å YouTube, SoundCloud –∏ Yandex Music",
    )
    @app_commands.describe(query="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ –∏–ª–∏ URL")
    async def play(
        self,
        interaction: Interaction,
        *,
        query: str,
        channel: discord.VoiceChannel = None,
        ephemeral: bool = False,
    ):
        """Play a song from various supported platforms"""
        # TODO: –ø—Ä–æ–≤–µ—Ä–∏—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        try:
            await interaction.response.defer(ephemeral=ephemeral)
            if not await self._ensure_voice(interaction, None):
                return

            if not await self._check_and_reconnect_node():
                await interaction.followup.send(
                    "‚ùå Audio service unavailable, reconnecting..."
                )

            player = await self._get_player(interaction.guild_id)
            await player.volume(self._current_volume)
            tracks = await self.node.auto_search_tracks(query)

            if isinstance(tracks, lavaplay.PlayList):
                logger.debug("Playlist found: %s tracks", len(tracks.tracks))
                await self._handle_playlist(interaction, player, tracks)
            elif isinstance(tracks, list) and len(tracks) > 0:
                logger.debug("Single track found: %s", tracks[0].title)
                await self._handle_track(interaction, player, tracks[0])
            else:
                logger.debug("No track results found for query: %s", query)
                await interaction.followup.send("‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
        except Exception as e:
            logger.exception("Unexpected error in play command: %s", e)
            await interaction.followup.send("‚ùå –Å–±–∞–Ω—ã–π —é—Ç—É–± –æ–ø—è—Ç—å —Å–ª–æ–º–∞–ª—Å—è.")

    async def _handle_track(
        self,
        interaction: Interaction,
        player: lavaplay.player.Player,
        track: lavaplay.Track,
    ):
        try:
            await player.play(track, requester=interaction.user.id)
            if len(player.queue) > 1:
                embed = discord.Embed(
                    title="‚úÖ –¢—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å unecesary",
                    description=f"[{track.title}]({track.uri})",
                    color=0xFFAE00,
                )
                embed.set_thumbnail(url=track.artworkUrl)
                return await interaction.followup.send(embed=embed, silent=True)
            embed = discord.Embed(
                title="üéµ –°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç",
                description=f"[{track.title}]({track.uri})",
                color=0xFFAE00,
            )
            embed.set_thumbnail(url=track.artworkUrl)
            await interaction.followup.send(embed=embed, silent=True)
        except lavaplay.TrackLoadFailed as e:
            logger.error("Track load error: %s", e)
            await interaction.followup.send("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–∫–∞: %s", e)
        except Exception as e:
            logger.exception("Unexpected error in _handle_track: %s", e)
            await interaction.followup.send(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ç—Ä–µ–∫–∞",
            )

    async def _handle_playlist(
        self,
        interaction: Interaction,
        player: lavaplay.player.Player,
        playlist: lavaplay.PlayList,
    ):
        try:
            await player.play_playlist(playlist)
            await interaction.followup.send(
                f"üé∂ –ü–ª–µ–π–ª–∏—Å—Ç **{playlist.name}** —Å {len(playlist.tracks)} —Ç—Ä–µ–∫–∞–º–∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å",
                silent=True,
            )
        except Exception as e:
            logger.exception("Unexpected error in _handle_playlist: %s", e)
            await interaction.followup.send(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –≤ –æ—á–µ—Ä–µ–¥—å"
            )

    async def _ensure_voice(
        self, interaction: Interaction, channel: discord.VoiceChannel = None
    ) -> bool:
        """Ensure bot is connected to voice channel"""
        if channel is None and not interaction.user.voice:
            await interaction.followup.send(
                "‚ùå –í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º –∫–∞–Ω–∞–ª–µ!", ephemeral=True
            )
            return False
        channel = channel or interaction.user.voice.channel

        if not interaction.guild.voice_client:
            try:
                if not any(channel.members):
                    await interaction.followup.send(
                        "‚ùå –ì–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª –ø—É—Å—Ç!", ephemeral=True
                    )
                    return False
                await channel.connect(cls=LavalinkVoiceClient, self_deaf=True)
                self.node.create_player(interaction.guild_id)
            except Exception as e:
                logger.exception(
                    "Error connecting bot to voice channel in _ensure_voice: %s", e
                )
                await interaction.followup.send(
                    "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –≥–æ–ª–æ—Å–æ–≤–æ–º—É –∫–∞–Ω–∞–ª—É", ephemeral=True
                )
                return False
        return True

    @app_commands.command(
        name="stop", description="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏ –æ—á–∏—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥—å"
    )
    async def stop(self, interaction: Interaction):
        """Stop the player and clear queue"""
        try:
            logger.debug("Stop command invoked")
            player = self.node.get_player(interaction.guild_id)
            if not player:
                logger.debug("Player not found in stop command")
                return await interaction.response.send_message(
                    "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ", ephemeral=True
                )
            await player.stop()
            player.queue.clear()
            await interaction.response.send_message(
                "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –æ—á–µ—Ä–µ–¥—å –æ—á–∏—â–µ–Ω–∞",
                delete_after=15,
                silent=True,
            )
            logger.info("Playback stopped and queue cleared")
        except Exception as e:
            logger.exception("Unexpected error in stop command: %s", e)
            await interaction.response.send_message(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è", ephemeral=True
            )

    @app_commands.command(name="skip", description="–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫")
    async def skip(self, interaction: Interaction):
        """Skip to the next track in queue"""
        try:
            logger.debug("Skip command invoked")
            player = self.node.get_player(interaction.guild_id)
            if not player:
                logger.debug("Player not found in skip command")
                return await interaction.response.send_message(
                    "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç—Ä–µ–∫", ephemeral=True
                )
            await player.skip()
            await interaction.response.send_message(
                "‚è≠Ô∏è –¢–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –ø—Ä–æ–ø—É—â–µ–Ω", delete_after=15, silent=True
            )
            logger.info("Track skipped")
        except Exception as e:
            logger.exception("Unexpected error in skip command: %s", e)
            await interaction.response.send_message(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–µ —Ç—Ä–µ–∫–∞", ephemeral=True
            )

    @app_commands.command(
        name="pause", description="–ü–æ—Å—Ç–∞–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –ø–∞—É–∑—É"
    )
    async def pause(self, interaction: Interaction):
        """Pause the current track"""
        try:
            logger.debug("Pause command invoked")
            player = self.node.get_player(interaction.guild_id)
            if not player:
                logger.debug("Player not found in pause command")
                return await interaction.response.send_message(
                    "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ", ephemeral=True
                )
            await player.pause(True)
            await interaction.response.send_message(
                "‚è∏Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", ephemeral=True, silent=True
            )
            logger.info("Playback paused")
        except Exception as e:
            logger.exception("Unexpected error in pause command: %s", e)
            await interaction.response.send_message(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–µ –Ω–∞ –ø–∞—É–∑—É", ephemeral=True
            )

    @app_commands.command(name="resume", description="–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ")
    async def resume(self, interaction: Interaction):
        """Resume paused playback"""
        try:
            logger.debug("Resume command invoked")
            player = self.node.get_player(interaction.guild_id)
            if not player:
                logger.debug("Player not found in resume command")
                return await interaction.response.send_message(
                    "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ", ephemeral=True
                )
            await player.pause(False)
            await interaction.response.send_message(
                "‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–æ", ephemeral=True, silent=True
            )
            logger.info("Playback resumed")
        except Exception as e:
            logger.exception("Unexpected error in resume command: %s", e)
            await interaction.response.send_message(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è", ephemeral=True
            )

    @app_commands.command(name="queue", description="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –æ—á–µ—Ä–µ–¥—å")
    async def queue(
        self,
        interaction: Interaction,
        *,
        ephemeral: bool = False,
    ):
        """Display the current playback queue"""
        try:
            logger.debug("Queue command invoked")
            await self._check_and_reconnect_node()
            player = await self._get_player(interaction.guild_id)
            if not player or not player.queue:
                logger.debug("Queue is empty")
                return await interaction.response.send_message(
                    "‚ùå –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞", ephemeral=True
                )
            embed = discord.Embed(title="–û—á–µ—Ä–µ–¥—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è", color=0xFFAE00)
            if player.is_playing:
                embed.add_field(
                    name="–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç",
                    value=f"[{player.queue[0]}]({player.queue[0].uri})",
                    inline=False,
                )
            queue_text = "\n".join(
                f"{idx + 1}. [{track.title}]({track.uri})"
                for idx, track in enumerate(player.queue[1:10])
            )
            if len(player.queue) > 10:
                queue_text += f"\n... (+{len(player.queue) - 10} –æ—Å—Ç–∞–ª—å–Ω—ã—Ö)"
            if queue_text:
                embed.add_field(name="–î–∞–ª–µ–µ", value=queue_text, inline=False)

            await interaction.response.send_message(
                embed=embed, ephemeral=ephemeral, silent=True
            )
            logger.info("Queue displayed")
        except Exception as e:
            logger.exception("Unexpected error in queue command: %s", e)
            await interaction.response.send_message(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ –æ—á–µ—Ä–µ–¥–∏", ephemeral=True
            )

    @app_commands.command(
        name="volume", description="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (0-200)"
    )
    @app_commands.describe(volume="–£—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏ (0-200)")
    async def volume(
        self, interaction: Interaction, volume: app_commands.Range[int, 0, 200]
    ):
        """Adjust playback volume"""
        try:
            logger.debug("Volume command invoked with volume: %d", volume)
            player = self.node.get_player(interaction.guild_id)
            if player:
                await player.volume(volume)
            self._current_volume = volume
            await interaction.response.send_message(
                f"üîä –ì—Ä–æ–º–∫–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ {volume}%", ephemeral=True, silent=True
            )
            logger.info("Volume set to %d", volume)
        except Exception as e:
            logger.exception("Unexpected error in volume command: %s", e)
            await interaction.response.send_message(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏", ephemeral=True
            )

    @app_commands.command(name="leave", description="–ü–æ–∫–∏–Ω—É—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª")
    async def leave(self, interaction: Interaction):
        """Disconnect from voice channel"""
        try:
            logger.debug("Leave command invoked")
            player = self.node.get_player(interaction.guild_id)
            if player and player.is_connected:
                await player.destroy()
            if not interaction.guild.voice_client:
                logger.debug("Bot is not connected to a voice channel during leave")
                return await interaction.response.send_message(
                    "–ù–µ –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º –∫–∞–Ω–∞–ª–µ", ephemeral=True, silent=True
                )
            await interaction.guild.voice_client.disconnect(force=True)
            await interaction.response.send_message(
                "–ü–æ–∫–∏–Ω—É–ª –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª", ephemeral=True, silent=True
            )
            logger.info("Left voice channel")
        except Exception as e:
            logger.exception("Unexpected error in leave command: %s", e)
            await interaction.response.send_message(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞", ephemeral=True
            )

    @app_commands.command(
        name="rotate-queue",
        description="–ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ –∫–æ–Ω–µ—Ü.",
    )
    async def rotate(self, interaction: Interaction):
        try:
            logger.debug("Rotate command invoked")
            player = self.node.get_player(interaction.guild_id)
            if not player:
                logger.debug("Player not found in skip command")
                return await interaction.response.send_message(
                    "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç—Ä–µ–∫", ephemeral=True
                )
            current_track = player.queue[0] if player.queue else None
            if current_track is None:
                return await interaction.response.send_message(
                    "‚ùå –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞", ephemeral=True
                )
            await player.play(current_track, requester=current_track.requester)
            await player.skip()
            await interaction.response.send_message(
                "‚è≠Ô∏è –¢–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –ø—Ä–æ–ø—É—â–µ–Ω –∏ –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ –∫–æ–Ω–µ—Ü",
                delete_after=15,
                silent=True,
            )
            logger.info(
                "Track rotated %s: %s",
                current_track.uri,
                " | ".join(list(t.uri for t in player.queue)),
            )
        except Exception as e:
            logger.exception("Unexpected error in skip command: %s", e)
            await interaction.response.send_message(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–æ—Ç–∞—Ü–∏–∏ —Ç—Ä–µ–∫–∞", ephemeral=True
            )


class LavalinkVoiceClient(discord.VoiceClient):
    """
    A voice client for Lavalink.
    https://discordpy.readthedocs.io/en/latest/api.html#voiceprotocol
    """

    def __init__(self, client: discord.Client, channel: discord.abc.Connectable):
        logger.debug("[INIT] Creating voice client...")
        try:
            self.client = client
            self.channel = channel
            music_cog: MusicCog = self.client.get_cog("MusicCog")
            if not music_cog:
                raise RuntimeError("MusicCog not loaded!")

            self.lavalink = music_cog.node  # Access node directly from cog
            logger.debug("[INIT] Lavalink assigned; Lavalink: %s", self.lavalink)
        except Exception as e:
            logger.exception("Unexpected error in voice client init: %s", e)

    async def on_voice_server_update(self, data):
        logger.debug("[VOICE SERVER UPDATE] Received data: %s", data)
        player = self.lavalink.get_player(self.channel.guild.id)
        await player.raw_voice_server_update(data.get("endpoint"), data.get("token"))

    async def on_voice_state_update(self, data):
        logger.debug("[VOICE STATE UPDATE] Received data: %s", data)
        player = self.lavalink.get_player(self.channel.guild.id)
        await player.raw_voice_state_update(
            int(data["user_id"]), data["session_id"], int(data["channel_id"])
        )

    async def connect(
        self,
        *,
        timeout: float,
        reconnect: bool,
        self_deaf: bool = False,
        self_mute: bool = False,
    ) -> None:
        logger.debug("[CONNECT] Attempting to connect voice client...")
        await self.channel.guild.change_voice_state(
            channel=self.channel, self_mute=self_mute, self_deaf=self_deaf
        )

    async def disconnect(self, *, force: bool = False) -> None:
        logger.debug("[DISCONNECT] Attempting to disconnect voice client...")

        await self.channel.guild.change_voice_state(channel=None)
        self.cleanup()


async def setup(bot: commands.Bot):
    await bot.add_cog(MusicCog(bot))
